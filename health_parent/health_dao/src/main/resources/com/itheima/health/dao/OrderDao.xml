<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
 <!-- namespace:要关联的接口的全限定名 -->
<mapper namespace="com.itheima.health.dao.OrderDao">
    <select id="findOrderByMember" parameterType="Map" resultType="Order">
        select * from t_order where member_id = #{member_id} and orderDate = #{orderDate} and id = #{id}
    </select>

    <insert id="addOrder" parameterType="Order">
        <selectKey resultType="java.lang.Integer" order="AFTER" keyProperty="id">
            SELECT LAST_INSERT_ID()
        </selectKey>
        insert into t_order(member_id,orderDate,orderType,orderStatus,setmeal_id)
        values (#{memberId},#{orderDate,jdbcType=DATE},#{orderType},#{orderStatus},#{setmealId})
    </insert>

    <select id="findById" parameterType="int" resultType="Order">
        select * from t_order where id = #{id}
    </select>

    <!--根据预约id查询预约信息，包括体检人信息、套餐信息-->
    <select id="findById4Detail" parameterType="int" resultType="map">
        select
            m.name member,s.name setmeal,
            date_format(o.orderDate,'%Y-%m-%d') orderDate,
            o.orderType
        from
            t_member m,t_order o,t_setmeal s
        where s.id=o.setmeal_id and m.id=o.member_id
        and o.id=#{id}
    </select>

    <!--根据日期统计预约数-->
    <select id="findOrderCountByDate" parameterType="string" resultType="int">
        select count(id) from t_order where orderDate = #{value}
    </select>

    <!--根据日期统计预约数，统计指定日期之后的预约数-->
    <select id="findOrderCountAfterDate" parameterType="string" resultType="int">
        select count(id) from t_order where orderDate &gt;= #{value}
    </select>

    <!--根据日期统计到诊数-->
    <select id="findVisitsCountByDate" parameterType="string" resultType="int">
        select count(id) from t_order where orderDate = #{value} and orderStatus = '已到诊'
    </select>

    <!--根据日期统计到诊数，统计指定日期之后的到诊数-->
    <select id="findVisitsCountAfterDate" parameterType="string" resultType="int">
        select count(id) from t_order where orderDate &gt;= #{value} and orderStatus = '已到诊'
    </select>

    <select id="findOrderCountBetweenDate" parameterType="string" resultType="int">
        select count(1) from t_order where orderDate between #{startDate} and #{endDate}
    </select>

    <!--热门套餐，查询前5条-->
    <select id="findHotSetmeal" resultType="map">
        select s.name,t1.setmeal_count ,t1.proportion,s.remark from t_setmeal s inner join (
            select setmeal_id,count(1) setmeal_count,count(1)/t.total proportion
            from t_order o,
			(select count(1) total from t_order) t group by setmeal_id
        ) t1 on s.id=t1.setmeal_id order by t1.setmeal_count desc limit 0,4
    </select>
</mapper>